{{define "content"}}
<div class="max-w-5xl mx-auto text-center px-4 py-10">
    
    {{if .IsResult}}
    <div class="mb-12">
        <div class="inline-block p-3 bg-emerald-500/20 rounded-full mb-4 border border-emerald-500/30">
            <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h2 class="text-3xl font-bold text-slate-100">카드 선택이 완료되었습니다.</h2>
        <p class="text-slate-400 mt-2">총 {{.PickCount}}장의 카드가 모두 상담사에게 전달되었습니다.</p>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6 mb-12">
        {{range .DisplayCards}}
        <div class="flex flex-col items-center group">
            <div class="relative w-full aspect-[2/3] mb-3 shadow-2xl rounded-xl overflow-hidden border-4 border-white/10 transition-transform group-hover:scale-105">
                <div class="absolute top-2 left-2 w-7 h-7 bg-slate-900/90 text-amber-400 text-xs flex items-center justify-center rounded-full backdrop-blur-sm z-10 border border-amber-500/30">
                    {{.Position}}
                </div>
                <img src="/static{{.ImgPath}}" alt="{{.CardName}}" class="w-full h-full object-cover">
            </div>
            <p class="font-bold text-amber-200">{{.CardName}}</p>
        </div>
        {{end}}
    </div>

    {{else}}
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-slate-100">반갑습니다.</h2>
        <p class="text-amber-400 font-semibold text-lg mt-2">
            {{if gt .AlreadyPick 0}}
                이미 {{.AlreadyPick}}장을 뽑으셨습니다. 남은 <span class="underline decoration-wavy">{{.PickCount}}장</span>을 추가로 골라주세요.
            {{else}}
                준비된 카드 중 <span class="underline decoration-wavy">{{.PickCount}}장</span>을 신중하게 골라주세요.
            {{end}}
        </p>
        <div class="mt-4 flex justify-center gap-4 text-sm font-medium">
            <span class="text-slate-500">나열된 카드: {{len .DisplayCards}}장</span>
            <span class="text-slate-500">|</span>
            <span class="text-slate-300">현재 선택: <span id="count" class="text-rose-400 font-bold">0</span> / {{.PickCount}}</span>
        </div>
    </div>

    <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3 mb-12">
        {{range .DisplayCards}}
        <div onclick="selectCard(this, {{.}})" 
             class="card-item relative aspect-[2/3] bg-slate-800 rounded-lg shadow-lg cursor-pointer border-2 border-white/20 hover:border-amber-500/50 hover:-translate-y-2 transition-all group">
            <div class="absolute inset-0 flex items-center justify-center opacity-10 group-hover:opacity-30 transition-opacity">
                <span class="text-white text-[10px] font-bold uppercase tracking-tighter">Stella Tarot</span>
            </div>
            <div class="selected-mark hidden absolute inset-0 bg-amber-500/60 flex items-center justify-center rounded-lg backdrop-blur-[2px]">
                <span class="text-white text-2xl font-bold">✓</span>
            </div>
        </div>
        {{end}}
    </div>

    <form id="submitForm" action="/select-cards/{{.EncKey}}" method="POST">
        <input type="hidden" name="reservation_idx" value="{{.Idx}}">
        <input type="hidden" name="selected_values" id="selectedValues">
        <button type="button" onclick="submitCards()" id="submitBtn" disabled
                class="bg-slate-700 text-slate-400 px-16 py-4 rounded-full text-xl font-bold shadow-xl transition-all cursor-not-allowed border border-white/5">
            선택 완료
        </button>
    </form>
    {{end}}
</div>

<script>
    let selected = [];
    const pickLimit = {{.PickCount}}; 

    function selectCard(el, cardVal) {
        const idx = selected.indexOf(cardVal);
        
        if (idx > -1) {
            selected.splice(idx, 1);
            el.querySelector('.selected-mark').classList.add('hidden');
            el.classList.remove('ring-4', 'ring-amber-500/50');
        } else {
            if (selected.length >= pickLimit) {
                alert(`이미 ${pickLimit}장을 모두 선택하셨습니다.`);
                return;
            }
            selected.push(cardVal);
            el.querySelector('.selected-mark').classList.remove('hidden');
            el.classList.add('ring-4', 'ring-amber-500/50');
        }

        document.getElementById('count').innerText = selected.length;
        document.getElementById('selectedValues').value = selected.join(',');
        
        const btn = document.getElementById('submitBtn');
        if (selected.length === pickLimit) {
            btn.disabled = false;
            // 버튼 활성화 시 색상 변경
            btn.classList.replace('bg-slate-700', 'bg-gradient-to-r');
            btn.classList.add('from-amber-600', 'to-amber-500', 'text-slate-900');
            btn.classList.remove('cursor-not-allowed', 'text-slate-400');
        } else {
            btn.disabled = true;
            btn.classList.replace('bg-gradient-to-r', 'bg-slate-700');
            btn.classList.remove('from-amber-600', 'to-amber-500', 'text-slate-900');
            btn.classList.add('cursor-not-allowed', 'text-slate-400');
        }
    }

    function submitCards() {
        if (selected.length !== pickLimit) return;
        if (confirm(`${selected.length}장의 카드를 제출하시겠습니까?`)) {
            document.getElementById('submitForm').submit();
        }
    }
</script>

<style>
    .card-item {
        background: linear-gradient(145deg, #1e293b, #0f172a);
    }
</style>
{{end}}